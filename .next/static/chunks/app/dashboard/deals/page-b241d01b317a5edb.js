(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[431],{3012:function(e,t,r){Promise.resolve().then(r.bind(r,2409))},2409:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return m}});var a=r(7437),n=r(2265),s=r(2108),o=r(9376),l=r(925),i=r(4362),d=r(5978),c=r(9520);r(1005);var u=r(795),g=r(3662);function m(){(0,o.useRouter)();let{user:e}=(0,i.a)(),[t,r]=(0,n.useState)([]),[m,h]=(0,n.useState)(!0),[b,f]=(0,n.useState)(null),p=(0,u.Dy)((0,u.VT)(u.we,{activationConstraint:{distance:5}}),(0,u.VT)(u.Lg,{coordinateGetter:g.is})),[v,N]=(0,n.useState)(!1),[k,w]=(0,n.useState)({title:"",value:0,status:"OPEN",customerId:"",customerName:"",closingDate:null,userId:(null==e?void 0:e.id)||""});(0,n.useEffect)(()=>{!async function(){if(null==e?void 0:e.id)try{let t=[...(await (0,l.qi)(l.Ul.DEALS)).filter(t=>t.userId===e.id)];try{let e=await (0,l.qi)(l.Ul.CUSTOMERS);for(let r of t){if(!r.customerId)continue;let t=e.find(e=>e.id===r.customerId);t&&(r.customerName=t.name)}}catch(e){console.error("Error fetching customer data:",e)}r(t)}catch(e){console.error("Error fetching deals:",e)}finally{h(!1)}}()},[null==e?void 0:e.id]);let E=t.filter(e=>"OPEN"===e.status),j=t.filter(e=>"PENDING"===e.status),I=t.filter(e=>"WON"===e.status),D=t.filter(e=>"LOST"===e.status),S=async()=>{if(""!==k.title.trim()&&k.customerName&&(null==e?void 0:e.id))try{let a=k.customerId||"temp-customer-".concat(Date.now()),n={title:k.title,value:k.value,status:k.status,customerId:a,userId:e.id,customerName:k.customerName,...k.closingDate&&{closingDate:d.EK.fromDate(k.closingDate)}},s={...await (0,l.OE)(l.Ul.DEALS,n),customerName:k.customerName};r([...t,s]),w({title:"",value:0,status:"OPEN",customerId:"",customerName:"",closingDate:null,userId:e.id}),N(!1)}catch(e){console.error("Error adding deal:",e)}},C=async e=>{try{await (0,l.iH)(l.Ul.DEALS,e),r(t.filter(t=>t.id!==e))}catch(e){console.error("Error deleting deal:",e)}},P=async(e,a)=>{try{await (0,l.gU)(l.Ul.DEALS,e,{status:a}),r(t.map(t=>t.id===e?{...t,status:a}:t))}catch(e){console.error("Error updating deal status:",e)}},U=async e=>{let{active:a,over:n}=e;if(f(null),!n){console.log("Dropped outside droppable area");return}let s=a.id,o=n.id;console.log("Moving deal ".concat(s," to ").concat(o));let i=t.find(e=>e.id===s);if(!i){console.error("Could not find deal with ID ".concat(s));return}if(i.status===o){console.log("Status unchanged");return}try{await (0,l.gU)(l.Ul.DEALS,s,{status:o}),r(t.map(e=>e.id===s?{...e,status:o}:e)),console.log("Successfully updated deal ".concat(s," to status ").concat(o))}catch(e){console.error("Error updating deal status:",e),alert("Failed to update deal status. Please try again.")}},_=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),M=e=>{if(!e)return"No date set";let t=e instanceof d.EK?e.toDate():e instanceof Date?e:null;return t?(0,s.WU)(t,"MMM d, yyyy"):"Invalid date"};return m?(0,a.jsx)("div",{className:"text-center p-8 dark:text-white",children:"Загрузка данных..."}):(0,a.jsxs)("div",{className:"container mx-auto p-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold dark:text-white",children:"Сделки"}),(0,a.jsx)("button",{onClick:()=>N(!0),className:"bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md",children:"Добавить сделку"})]}),(0,a.jsxs)(u.LB,{sensors:p,collisionDetection:u.pE,onDragStart:e=>{let{active:r}=e,a=t.find(e=>e.id===r.id);a&&f(a)},onDragEnd:U,children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[(0,a.jsx)(x,{title:"Открытые",count:E.length,status:"OPEN",deals:E,color:"blue",onMove:P,onDelete:C,formatCurrency:_,formatDate:M}),(0,a.jsx)(x,{title:"В ожидании",count:j.length,status:"PENDING",deals:j,color:"yellow",onMove:P,onDelete:C,formatCurrency:_,formatDate:M}),(0,a.jsx)(x,{title:"Выигранные",count:I.length,status:"WON",deals:I,color:"green",onMove:P,onDelete:C,formatCurrency:_,formatDate:M}),(0,a.jsx)(x,{title:"Проигранные",count:D.length,status:"LOST",deals:D,color:"red",onMove:P,onDelete:C,formatCurrency:_,formatDate:M})]}),(0,a.jsx)(u.y9,{children:b?(0,a.jsx)("div",{className:"opacity-80 w-full",children:(0,a.jsx)(y,{deal:b,onMove:P,onDelete:C,formatCurrency:_,formatDate:M})}):null})]}),v&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md",children:[(0,a.jsx)("h2",{className:"text-xl font-bold mb-4 dark:text-white",children:"Добавить сделку"}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Название"}),(0,a.jsx)("input",{type:"text",value:k.title,onChange:e=>w({...k,title:e.target.value}),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white",placeholder:"Название сделки"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Клиент"}),(0,a.jsx)("input",{type:"text",value:k.customerName,onChange:e=>w({...k,customerName:e.target.value}),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white",placeholder:"Имя клиента"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Стоимость"}),(0,a.jsx)("input",{type:"number",value:k.value,onChange:e=>w({...k,value:Number(e.target.value)}),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white",placeholder:"Стоимость сделки",min:"0",step:"100"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Ожидаемая дата закрытия"}),(0,a.jsx)(c.ZP,{selected:k.closingDate,onChange:e=>w({...k,closingDate:e}),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white",placeholderText:"Выберите дату закрытия"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Статус"}),(0,a.jsxs)("select",{value:k.status,onChange:e=>w({...k,status:e.target.value}),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white",children:[(0,a.jsx)("option",{value:"OPEN",children:"Открыта"}),(0,a.jsx)("option",{value:"PENDING",children:"В ожидании"}),(0,a.jsx)("option",{value:"WON",children:"Выиграна"}),(0,a.jsx)("option",{value:"LOST",children:"Проиграна"})]})]})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2 mt-6",children:[(0,a.jsx)("button",{onClick:()=>N(!1),className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700",children:"Отменить"}),(0,a.jsx)("button",{onClick:S,className:"px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700",children:"Добавить сделку"})]})]})})]})}function x(e){let{title:t,count:r,status:n,deals:s,color:o,onMove:l,onDelete:i,formatCurrency:d,formatDate:c}=e,{setNodeRef:g,isOver:m}=(0,u.Zj)({id:n});return(0,a.jsxs)("div",{className:"bg-gray-100 dark:bg-gray-800 p-4 rounded-lg",children:[(0,a.jsxs)("div",{className:"flex items-center mb-4",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-".concat(o,"-500 rounded-full mr-2")}),(0,a.jsx)("h2",{className:"text-lg font-semibold dark:text-white",children:t}),(0,a.jsx)("span",{className:"ml-auto bg-".concat(o,"-500 text-white text-xs px-2 py-1 rounded-full"),children:r})]}),(0,a.jsx)("div",{ref:g,className:"space-y-3 min-h-[100px] rounded-md transition-colors duration-200 p-2 ".concat((()=>{if(m)switch(o){case"blue":return"bg-blue-50 dark:bg-blue-900/20 ring-2 ring-blue-200 dark:ring-blue-800";case"yellow":return"bg-yellow-50 dark:bg-yellow-900/20 ring-2 ring-yellow-200 dark:ring-yellow-800";case"green":return"bg-green-50 dark:bg-green-900/20 ring-2 ring-green-200 dark:ring-green-800";case"red":return"bg-red-50 dark:bg-red-900/20 ring-2 ring-red-200 dark:ring-red-800"}return""})()),children:0===s.length?(0,a.jsx)("div",{className:"text-center p-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-400",children:"Сделок нет"}):s.map(e=>(0,a.jsx)(h,{deal:e,onMove:l,onDelete:i,formatCurrency:d,formatDate:c},e.id))})]})}function h(e){let{deal:t,onMove:r,onDelete:n,formatCurrency:s,formatDate:o}=e,{attributes:l,listeners:i,setNodeRef:d,transform:c,isDragging:g}=(0,u.O1)({id:t.id||""}),m=c?{transform:"translate3d(".concat(c.x,"px, ").concat(c.y,"px, 0)"),opacity:g?.5:1}:void 0;return(0,a.jsx)("div",{ref:d,style:m,...i,...l,children:(0,a.jsx)(y,{deal:t,onMove:r,onDelete:n,formatCurrency:s,formatDate:o})})}function y(e){let{deal:t,onMove:r,onDelete:s,formatCurrency:o,formatDate:l}=e,[i,d]=(0,n.useState)(!1),c=t.id||"",u=t.customerId||"",g=t.customerName||"Customer ".concat(u.substring(0,Math.min(5,u.length)),"...");return(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-700 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-600 relative group",children:[(0,a.jsx)("div",{className:"absolute top-2 left-2 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors duration-200",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 8h16M4 16h16"})})}),(0,a.jsxs)("div",{className:"flex justify-between items-start ml-5",children:[(0,a.jsx)("h3",{className:"font-medium dark:text-white",children:t.title}),(0,a.jsxs)("div",{className:"relative z-10",children:[" ",(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),d(!i)},className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{d:"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"})})}),i&&(0,a.jsx)("div",{className:"absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 border border-gray-200 dark:border-gray-700",children:(0,a.jsxs)("div",{className:"py-1",children:["OPEN"!==t.status&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),r(c,"OPEN"),d(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Move to Open"}),"PENDING"!==t.status&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),r(c,"PENDING"),d(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Move to Pending"}),"WON"!==t.status&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),r(c,"WON"),d(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Move to Won"}),"LOST"!==t.status&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),r(c,"LOST"),d(!1)},className:"block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Move to Lost"}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),s(c),d(!1)},className:"block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Delete"})]})})]})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:g}),(0,a.jsx)("p",{className:"text-lg font-semibold mt-2 dark:text-white",children:o(t.value)}),(0,a.jsxs)("div",{className:"flex items-center mt-2 text-xs text-gray-500 dark:text-gray-400",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),l(t.closingDate)]})]})}},4362:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return i},a:function(){return d}});var a=r(7437),n=r(2265),s=r(8123),o=r(6410);let l=(0,n.createContext)({firebaseUser:null,user:null,loading:!0,error:null});function i(e){let{children:t}=e,[r,i]=(0,n.useState)(null),[d,c]=(0,n.useState)(null),[u,g]=(0,n.useState)(!0),[m,x]=(0,n.useState)(null);return(0,n.useEffect)(()=>{if(!o.l2)return g(!1),x("Firebase is not properly configured. Please check your environment variables."),()=>{};try{let e=(0,s.yv)(async e=>{if(i(e),e)try{let e=await (0,s.ts)();c(e)}catch(e){console.error("Error getting user data:",e),x("Error loading user data")}else c(null);g(!1)});return()=>e()}catch(e){return console.error("Error setting up auth listener:",e),g(!1),x("Error initializing authentication"),()=>{}}},[]),(0,a.jsx)(l.Provider,{value:{firebaseUser:r,user:d,loading:u,error:m},children:t})}function d(){return(0,n.useContext)(l)}},8123:function(e,t,r){"use strict";r.d(t,{a$:function(){return l},ts:function(){return c},w7:function(){return d},yv:function(){return u},zB:function(){return i}});var a=r(3301),n=r(5978),s=r(6410),o=r(925);async function l(e,t,r){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"USER";if(!s.I8||!s.db)throw Error("Firebase is not initialized");let i=(await (0,a.Xb)(s.I8,e,t)).user,d={name:r,email:e,role:l};return await (0,n.pl)((0,n.JU)(s.db,o.Ul.USERS,i.uid),d),{...d,id:i.uid}}async function i(e,t){if(!s.I8)throw Error("Firebase is not initialized");return(0,a.e5)(s.I8,e,t)}async function d(){if(!s.I8)throw Error("Firebase is not initialized");return(0,a.w7)(s.I8)}async function c(){if(!s.I8||!s.db)throw Error("Firebase is not initialized");let e=s.I8.currentUser;if(!e)return null;let t=await (0,n.QT)((0,n.JU)(s.db,o.Ul.USERS,e.uid));return t.exists()?{id:e.uid,...t.data()}:null}function u(e){if(!s.I8)throw Error("Firebase is not initialized");return(0,a.Aj)(s.I8,e)}},6410:function(e,t,r){"use strict";r.d(t,{I8:function(){return c},db:function(){return d},l2:function(){return i}});var a=r(738),n=r(5978),s=r(3301),o=r(257);let l={apiKey:"AIzaSyDpUQ4adXyWWieDcE63OnU2uLzX9C8WVyI",authDomain:"crm-system2014812.firebaseapp.com",projectId:"crm-system2014812",storageBucket:"crm-system2014812.firebasestorage.app",messagingSenderId:"281061278803",appId:"1:281061278803:web:7b2d18b0b67fcbeb1832a6",...o.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID?{measurementId:o.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}:{}};console.log("Firebase config check:"),console.log("API Key exists:",!0),console.log("Auth Domain exists:",!0),console.log("Project ID exists:",!0),console.log("Storage Bucket exists:",!0),console.log("Messaging Sender ID exists:",!0),console.log("App ID exists:",!0);let i=null,d=null,c=null;if(l.apiKey&&l.authDomain&&l.projectId)try{i=(0,a.ZF)(l),d=(0,n.ad)(i),c=(0,s.v0)(i),console.log("Firebase initialized successfully!")}catch(e){console.error("Firebase initialization error:",e),i=null,d=null,c=null}else console.warn("Firebase configuration is missing. Please set environment variables."),l.apiKey||console.warn("Missing: NEXT_PUBLIC_FIREBASE_API_KEY"),l.authDomain||console.warn("Missing: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"),l.projectId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_PROJECT_ID"),l.storageBucket||console.warn("Missing: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"),l.messagingSenderId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"),l.appId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_APP_ID")},925:function(e,t,r){"use strict";r.d(t,{OE:function(){return o},Ul:function(){return s},gU:function(){return i},iH:function(){return d},qi:function(){return l}});var a=r(5978),n=r(6410);let s={USERS:"users",CUSTOMERS:"customers",DEALS:"deals",TASKS:"tasks",NOTES:"notes",CONTACTS:"contacts"};async function o(e,t){let r=(0,a.hJ)(n.db,e);return{id:(await (0,a.ET)(r,{...t,createdAt:(0,a.Bt)(),updatedAt:(0,a.Bt)()})).id,...t}}async function l(e){let t=(0,a.hJ)(n.db,e);return(await (0,a.PL)(t)).docs.map(e=>({id:e.id,...e.data()}))}async function i(e,t,r){let s=(0,a.JU)(n.db,e,t);return await (0,a.r7)(s,{...r,updatedAt:(0,a.Bt)()}),{id:t,...r}}async function d(e,t){let r=(0,a.JU)(n.db,e,t);return await (0,a.oe)(r),{id:t}}}},function(e){e.O(0,[360,358,717,333,282,840,372,86,662,971,117,744],function(){return e(e.s=3012)}),_N_E=e.O()}]);