(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{1449:function(e,t,r){Promise.resolve().then(r.bind(r,3185))},3185:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return E}});var n=r(7437),a=r(2265),i=r(4362),s=r(925),o=r(5978),l=r(4993),d=r(9897),c=r(4293),u=r(5365),f=r(7967),m=r(5036);function g(e,t){let r=+(0,m.Q)(e)-+(0,m.Q)(t);return r<0?-1:r>0?1:r}var h=r(9955),p=r(817),x=r(1519),D=r(6062);function E(){let{user:e}=(0,i.a)(),[t,r]=(0,a.useState)([]),[E,v]=(0,a.useState)([]),[S,N]=(0,a.useState)([]),[A,I]=(0,a.useState)(!0);(0,a.useEffect)(()=>{!async function(){if(null==e?void 0:e.id)try{let t=(await (0,s.qi)(s.Ul.CUSTOMERS)).filter(t=>t.userId===e.id);r(t);let n=(await (0,s.qi)(s.Ul.DEALS)).filter(t=>t.userId===e.id);v(n);let a=(await (0,s.qi)(s.Ul.TASKS)).filter(t=>t.userId===e.id);N(a)}catch(e){console.error("Error fetching dashboard data:",e)}finally{I(!1)}}()},[null==e?void 0:e.id]);let k=t.length,j=E.filter(e=>"OPEN"===e.status||"PENDING"===e.status).length,T=E.filter(e=>{if("WON"!==e.status&&"LOST"!==e.status)return!1;let t=new Date,r=t.getMonth(),n=t.getFullYear();if(!e.updatedAt)return!1;let a=e.updatedAt instanceof o.EK?e.updatedAt.toDate():new Date(e.updatedAt);return a.getMonth()===r&&a.getFullYear()===n}).length,M=(0,a.useMemo)(()=>[...S].filter(e=>!e.completed).sort((e,t)=>{if(!e.dueDate)return 1;if(!t.dueDate)return -1;let r=e.dueDate instanceof o.EK?e.dueDate.toDate():new Date(e.dueDate),n=t.dueDate instanceof o.EK?t.dueDate.toDate():new Date(t.dueDate);return r.getTime()-n.getTime()}).slice(0,4),[S]),_=e=>{var t,r;return e?(r={addSuffix:!0},function(e,t,r){var n,a,i,s,o,l;let E;let y=(0,c.j)(),b=null!==(a=null!==(n=null==r?void 0:r.locale)&&void 0!==n?n:y.locale)&&void 0!==a?a:d._,w=g(e,t);if(isNaN(w))throw RangeError("Invalid time value");let v=Object.assign({},r,{addSuffix:null==r?void 0:r.addSuffix,comparison:w}),[S,N]=(0,f.d)(null==r?void 0:r.in,...w>0?[t,e]:[e,t]),A=(i=N,s=S,(l=null==void 0?void 0:(void 0).roundingMethod,e=>{let t=(l?Math[l]:Math.trunc)(e);return 0===t?0:t})((+(0,m.Q)(i)-+(0,m.Q)(s))/1e3)),I=Math.round((A-((0,u.D)(N)-(0,u.D)(S))/1e3)/60);if(I<2){if(null==r?void 0:r.includeSeconds){if(A<5)return b.formatDistance("lessThanXSeconds",5,v);if(A<10)return b.formatDistance("lessThanXSeconds",10,v);if(A<20)return b.formatDistance("lessThanXSeconds",20,v);if(A<40)return b.formatDistance("halfAMinute",0,v);else if(A<60)return b.formatDistance("lessThanXMinutes",1,v);else return b.formatDistance("xMinutes",1,v)}return 0===I?b.formatDistance("lessThanXMinutes",1,v):b.formatDistance("xMinutes",I,v)}if(I<45)return b.formatDistance("xMinutes",I,v);if(I<90)return b.formatDistance("aboutXHours",1,v);if(I<h.H_)return b.formatDistance("aboutXHours",Math.round(I/60),v);if(I<2520)return b.formatDistance("xDays",1,v);if(I<h.fH){let e=Math.round(I/h.H_);return b.formatDistance("xDays",e,v)}if(I<2*h.fH)return E=Math.round(I/h.fH),b.formatDistance("aboutXMonths",E,v);if((E=function(e,t,r){let[n,a,i]=(0,f.d)(void 0,e,e,t),s=g(a,i),o=Math.abs((0,p.T)(a,i));if(o<1)return 0;1===a.getMonth()&&a.getDate()>27&&a.setDate(30),a.setMonth(a.getMonth()-s*o);let l=g(a,i)===-s;(function(e,t){let r=(0,m.Q)(e,void 0);return+(0,x.i)(r,void 0)==+(0,D.V)(r,void 0)})(n)&&1===o&&1===g(n,i)&&(l=!1);let d=s*(o-+l);return 0===d?0:d}(N,S))<12){let e=Math.round(I/h.fH);return b.formatDistance("xMonths",e,v)}{let e=E%12,t=Math.trunc(E/12);return e<3?b.formatDistance("aboutXYears",t,v):e<9?b.formatDistance("overXYears",t,v):b.formatDistance("almostXYears",t+1,v)}}(t=e instanceof o.EK?e.toDate():e instanceof Date?e:new Date(e),(0,l.L)(t,Date.now()),r)):"N/A"},U=(()=>{let e=[];for(let r of[...t].sort((e,t)=>{let r=e.createdAt instanceof o.EK?e.createdAt.toDate().getTime():0;return(t.createdAt instanceof o.EK?t.createdAt.toDate().getTime():0)-r}).slice(0,2))e.push({title:"New Customer Added",description:"".concat(r.name," was added as a new customer"),time:_(r.createdAt),timestamp:r.createdAt instanceof o.EK?r.createdAt.toDate().getTime():0});for(let t of[...E].filter(e=>"WON"===e.status||"LOST"===e.status).sort((e,t)=>{let r=e.updatedAt instanceof o.EK?e.updatedAt.toDate().getTime():0;return(t.updatedAt instanceof o.EK?t.updatedAt.toDate().getTime():0)-r}).slice(0,2))e.push({title:"Deal ".concat("WON"===t.status?"Won":"Lost"),description:"".concat(t.title," (").concat(t.customerName||"Unknown customer",") was marked as ").concat(t.status.toLowerCase()),time:_(t.updatedAt),timestamp:t.updatedAt instanceof o.EK?t.updatedAt.toDate().getTime():0});for(let t of[...S].filter(e=>e.completed).sort((e,t)=>{let r=e.updatedAt instanceof o.EK?e.updatedAt.toDate().getTime():0;return(t.updatedAt instanceof o.EK?t.updatedAt.toDate().getTime():0)-r}).slice(0,2))e.push({title:"Task Completed",description:t.title,time:_(t.updatedAt),timestamp:t.updatedAt instanceof o.EK?t.updatedAt.toDate().getTime():0});return e.sort((e,t)=>t.timestamp-e.timestamp).slice(0,4)})(),B=e=>{if(!e)return"No due date";let t=e instanceof o.EK?e.toDate():new Date(e),r=new Date;if(t.getDate()===r.getDate()&&t.getMonth()===r.getMonth()&&t.getFullYear()===r.getFullYear())return"Today";let n=new Date(r);return(n.setDate(n.getDate()+1),t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear())?"Tomorrow":t.toLocaleDateString("en-US",{month:"short",day:"numeric"})},C=async e=>{try{let t=S.find(t=>t.id===e);if(!t)return;await (0,s.gU)(s.Ul.TASKS,e,{completed:!t.completed}),N(S.map(t=>t.id===e?{...t,completed:!t.completed}:t))}catch(e){console.error("Error updating task completion:",e)}};return A?(0,n.jsx)("div",{className:"text-center p-8 dark:text-white",children:"Загрузка данных..."}):(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-2xl font-bold mb-6 dark:text-white",children:"Dashboard"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[(0,n.jsx)(y,{title:"Всего клиентов",value:k.toString(),change:t.length>0?"+1":"0",trend:"up"}),(0,n.jsx)(y,{title:"Активные сделки",value:j.toString(),change:j>0?"+1":"0",trend:"up"}),(0,n.jsx)(y,{title:"Закрытые сделки (Месяц)",value:T.toString(),change:T>0?"+1":"0",trend:"up"})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,n.jsxs)("div",{className:"bg-white dark:bg-gray-700 rounded-lg shadow p-6",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-4 dark:text-white",children:"Последние действия"}),(0,n.jsx)("div",{className:"space-y-4",children:0===U.length?(0,n.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:"Не найдено последних действий"}):U.map((e,t)=>(0,n.jsx)(b,{title:e.title,description:e.description,time:e.time},t))})]}),(0,n.jsxs)("div",{className:"bg-white dark:bg-gray-700 rounded-lg shadow p-6",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-4 dark:text-white",children:"Следующие задачи"}),(0,n.jsx)("div",{className:"space-y-3",children:0===M.length?(0,n.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:"Не найдено следующих задач"}):M.map(e=>(0,n.jsx)(w,{title:e.title,dueDate:B(e.dueDate),priority:e.priority||"medium",id:e.id||"",completed:e.completed,onTaskComplete:C},e.id))})]})]})]})}function y(e){let{title:t,value:r,change:a,trend:i}=e;return(0,n.jsxs)("div",{className:"bg-white dark:bg-gray-700 rounded-lg shadow p-6",children:[(0,n.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t}),(0,n.jsx)("p",{className:"text-3xl font-bold mt-1 dark:text-white",children:r}),(0,n.jsx)("div",{className:"flex items-center mt-2",children:(0,n.jsxs)("span",{className:"text-sm ".concat("up"===i?"text-green-500":"text-red-500"),children:[a,"up"===i?(0,n.jsx)("svg",{className:"w-3 h-3 ml-1 inline",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 10l7-7m0 0l7 7m-7-7v18"})}):(0,n.jsx)("svg",{className:"w-3 h-3 ml-1 inline",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})]})})]})}function b(e){let{title:t,description:r,time:a}=e;return(0,n.jsxs)("div",{className:"border-l-4 border-primary-500 pl-4 py-1",children:[(0,n.jsx)("p",{className:"font-medium dark:text-white",children:t}),(0,n.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:r}),(0,n.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:a})]})}function w(e){let{title:t,dueDate:r,priority:a,id:i,completed:s,onTaskComplete:o}=e;return(0,n.jsxs)("div",{className:"flex items-center justify-between p-3 border border-gray-200 dark:border-gray-600 dark:border-2 rounded-md dark:bg-gray-700",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("input",{type:"checkbox",className:"mr-3 h-4 w-4 text-primary-600 rounded",checked:s,onChange:()=>o(i)}),(0,n.jsx)("span",{className:"dark:text-white ".concat(s?"line-through text-gray-500 dark:text-gray-400":""),children:t})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-sm text-gray-500 dark:text-gray-400 mr-2",children:r}),(0,n.jsx)("span",{className:"text-xs px-2 py-1 rounded ".concat((()=>{switch(a){case"high":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"medium":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"low":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}})()),children:a})]})]})}},4362:function(e,t,r){"use strict";r.d(t,{AuthProvider:function(){return l},a:function(){return d}});var n=r(7437),a=r(2265),i=r(8123),s=r(6410);let o=(0,a.createContext)({firebaseUser:null,user:null,loading:!0,error:null});function l(e){let{children:t}=e,[r,l]=(0,a.useState)(null),[d,c]=(0,a.useState)(null),[u,f]=(0,a.useState)(!0),[m,g]=(0,a.useState)(null);return(0,a.useEffect)(()=>{if(!s.l2)return f(!1),g("Firebase is not properly configured. Please check your environment variables."),()=>{};try{let e=(0,i.yv)(async e=>{if(l(e),e)try{let e=await (0,i.ts)();c(e)}catch(e){console.error("Error getting user data:",e),g("Error loading user data")}else c(null);f(!1)});return()=>e()}catch(e){return console.error("Error setting up auth listener:",e),f(!1),g("Error initializing authentication"),()=>{}}},[]),(0,n.jsx)(o.Provider,{value:{firebaseUser:r,user:d,loading:u,error:m},children:t})}function d(){return(0,a.useContext)(o)}},8123:function(e,t,r){"use strict";r.d(t,{a$:function(){return o},ts:function(){return c},w7:function(){return d},yv:function(){return u},zB:function(){return l}});var n=r(3301),a=r(5978),i=r(6410),s=r(925);async function o(e,t,r){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"USER";if(!i.I8||!i.db)throw Error("Firebase is not initialized");let l=(await (0,n.Xb)(i.I8,e,t)).user,d={name:r,email:e,role:o};return await (0,a.pl)((0,a.JU)(i.db,s.Ul.USERS,l.uid),d),{...d,id:l.uid}}async function l(e,t){if(!i.I8)throw Error("Firebase is not initialized");return(0,n.e5)(i.I8,e,t)}async function d(){if(!i.I8)throw Error("Firebase is not initialized");return(0,n.w7)(i.I8)}async function c(){if(!i.I8||!i.db)throw Error("Firebase is not initialized");let e=i.I8.currentUser;if(!e)return null;let t=await (0,a.QT)((0,a.JU)(i.db,s.Ul.USERS,e.uid));return t.exists()?{id:e.uid,...t.data()}:null}function u(e){if(!i.I8)throw Error("Firebase is not initialized");return(0,n.Aj)(i.I8,e)}},6410:function(e,t,r){"use strict";r.d(t,{I8:function(){return c},db:function(){return d},l2:function(){return l}});var n=r(738),a=r(5978),i=r(3301),s=r(257);let o={apiKey:"AIzaSyDpUQ4adXyWWieDcE63OnU2uLzX9C8WVyI",authDomain:"crm-system2014812.firebaseapp.com",projectId:"crm-system2014812",storageBucket:"crm-system2014812.firebasestorage.app",messagingSenderId:"281061278803",appId:"1:281061278803:web:7b2d18b0b67fcbeb1832a6",...s.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID?{measurementId:s.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}:{}};console.log("Firebase config check:"),console.log("API Key exists:",!0),console.log("Auth Domain exists:",!0),console.log("Project ID exists:",!0),console.log("Storage Bucket exists:",!0),console.log("Messaging Sender ID exists:",!0),console.log("App ID exists:",!0);let l=null,d=null,c=null;if(o.apiKey&&o.authDomain&&o.projectId)try{l=(0,n.ZF)(o),d=(0,a.ad)(l),c=(0,i.v0)(l),console.log("Firebase initialized successfully!")}catch(e){console.error("Firebase initialization error:",e),l=null,d=null,c=null}else console.warn("Firebase configuration is missing. Please set environment variables."),o.apiKey||console.warn("Missing: NEXT_PUBLIC_FIREBASE_API_KEY"),o.authDomain||console.warn("Missing: NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"),o.projectId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_PROJECT_ID"),o.storageBucket||console.warn("Missing: NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"),o.messagingSenderId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"),o.appId||console.warn("Missing: NEXT_PUBLIC_FIREBASE_APP_ID")},925:function(e,t,r){"use strict";r.d(t,{OE:function(){return s},Ul:function(){return i},gU:function(){return l},iH:function(){return d},qi:function(){return o}});var n=r(5978),a=r(6410);let i={USERS:"users",CUSTOMERS:"customers",DEALS:"deals",TASKS:"tasks",NOTES:"notes",CONTACTS:"contacts"};async function s(e,t){let r=(0,n.hJ)(a.db,e);return{id:(await (0,n.ET)(r,{...t,createdAt:(0,n.Bt)(),updatedAt:(0,n.Bt)()})).id,...t}}async function o(e){let t=(0,n.hJ)(a.db,e);return(await (0,n.PL)(t)).docs.map(e=>({id:e.id,...e.data()}))}async function l(e,t,r){let i=(0,n.JU)(a.db,e,t);return await (0,n.r7)(i,{...r,updatedAt:(0,n.Bt)()}),{id:t,...r}}async function d(e,t){let r=(0,n.JU)(a.db,e,t);return await (0,n.oe)(r),{id:t}}}},function(e){e.O(0,[358,717,840,372,971,117,744],function(){return e(e.s=1449)}),_N_E=e.O()}]);